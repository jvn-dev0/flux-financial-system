<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberLens Admin - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #1a4d8c;
            --sidebar-blue: #2c7da0;
            --sidebar-dark: #1e5f7e;
            --light-bg: #f5f7fa;
            --white: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            --info: #17a2b8;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--light-bg);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (Same as User) */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--sidebar-blue) 0%, var(--sidebar-dark) 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-icon { font-size: 1.5rem; color: var(--white); }
        .logo-text { font-size: 1.2rem; font-weight: 700; }

        .nav-links {
            list-style: none;
            padding: 1rem 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: var(--white);
            border-left: 4px solid var(--white);
        }

        .nav-item i { width: 20px; text-align: center; }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .page-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--primary-blue);
        }

        /* Dashboard Body */
        .dashboard-body {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        /* Grid */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* Risk Summary Cards */
        .risk-card {
            grid-column: span 3;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .risk-icon {
            width: 50px; height: 50px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }

        .rc-red { background: #ffebee; color: var(--danger); }
        .rc-yellow { background: #fff8e1; color: var(--warning); }
        .rc-orange { background: #fff3e0; color: #fd7e14; }

        .rc-content h3 { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); }
        .rc-content p { font-size: 0.9rem; color: var(--text-light); }

        /* Charts */
        .chart-panel { grid-column: span 6; height: 350px; }
        .gauge-panel { grid-column: span 4; height: 350px; text-align: center; }
        .feed-panel { grid-column: span 8; height: 350px; overflow: hidden; }

        /* Threat Feed List */
        .feed-list {
            list-style: none;
            height: 280px;
            overflow-y: auto;
        }

        .feed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .feed-info { display: flex; gap: 10px; align-items: center; }
        .feed-id { font-weight: 600; color: var(--primary-blue); font-size: 0.9rem; }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .bdg-danger { background: #dc3545; color: white; }
        .bdg-warning { background: #ffc107; color: #333; }
        .bdg-info { background: #17a2b8; color: white; }

    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt logo-icon"></i>
            <div class="logo-text">CyberLens<br><span style="font-size:0.8rem; font-weight:400; opacity:0.8;">Admin Portal</span></div>
        </div>
        
        <ul class="nav-links">
            <a href="#" class="nav-item active"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="user_management.html" class="nav-item"><i class="fas fa-users-cog"></i> User Monitor</a>
            <a href="transaction_monitor.html" class="nav-item"><i class="fas fa-exchange-alt"></i> Live Transactions</a>
            <a href="risk_alerts.html" class="nav-item"><i class="fas fa-bell"></i> Risk Alerts</a>
            <a href="kyc_approval.html" class="nav-item"><i class="fas fa-id-card"></i> KYC Requests</a>
            <a href="reports.html" class="nav-item"><i class="fas fa-chart-bar"></i> Reports</a>
        </ul>

        <a href="login.html" class="nav-item" onclick="localStorage.removeItem('adminSession')" style="margin-top:auto; border-top:1px solid rgba(255,255,255,0.1);">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="header">
            <div class="page-title">Threat Intelligence Dashboard</div>
            <div class="admin-profile">
                <i class="fas fa-user-shield"></i> Administrator
            </div>
        </header>

        <div class="dashboard-body">
            
            <!-- 1. Stats Row -->
            <div class="grid-container">
                <div class="card risk-card rc-red" style="grid-column: span 4;">
                    <div class="risk-icon rc-red"><i class="fas fa-bell"></i></div>
                    <div class="rc-content">
                        <h3>0</h3>
                        <p>Open Alerts</p>
                    </div>
                </div>
                <div class="card risk-card rc-yellow" style="grid-column: span 4;">
                    <div class="risk-icon rc-yellow"><i class="fas fa-user-lock"></i></div>
                    <div class="rc-content">
                        <h3>0</h3>
                        <p>Risky Users</p>
                    </div>
                </div>
                <div class="card risk-card rc-orange" style="grid-column: span 4;">
                    <div class="risk-icon rc-orange"><i class="fas fa-eye"></i></div>
                    <div class="rc-content">
                        <h3>0</h3>
                        <p>Monitored Users</p>
                    </div>
                </div>
            </div>

            <!-- 2. Charts Row -->
            <div class="grid-container">
                <!-- Gauge -->
                <div class="card gauge-panel">
                    <div class="section-title">System Risk Score</div>
                    <div style="height:200px; position:relative;">
                        <canvas id="gaugeChart"></canvas>
                    </div>
                    <h2 style="font-size:3rem; color:#28a745; margin-top:-20px;">0</h2>
                    <p style="color:#666;">Level: System Secure</p>
                </div>

                <!-- Feed -->
                <div class="card feed-panel">
                    <div class="section-title">Live Threat Feed</div>
                    <ul class="feed-list" id="feed-container">
                        <!-- JS Populated -->
                    </ul>
                </div>
            </div>

            <!-- 3. Analytics -->
            <div class="grid-container">
                <div class="card chart-panel" style="grid-column: span 12;">
                    <div class="section-title">Threat Analytics (Last 24 Hours)</div>
                    <div style="height:280px;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Check Auth
        if(!localStorage.getItem('adminSession')) {
            window.location.href = 'login.html';
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();

                // Update Counters
                // Note: The UI card sequence is Open Alerts, Risky Users, Monitored Users
                // But API returns total_users, active_sessions, flagged_transactions, pending_kyc
                
                // Card 1: Open Alerts (Flagged Transactions)
                document.querySelector('.rc-red h3').innerText = data.flagged_transactions;
                
                // Card 2: Pending KYC (Risky/Attention needed)
                document.querySelector('.rc-yellow h3').innerText = data.pending_kyc;
                document.querySelector('.rc-yellow p').innerText = "Pending KYC";

                // Card 3: Total Users
                document.querySelector('.rc-orange h3').innerText = data.total_users;
                document.querySelector('.rc-orange p').innerText = "Total Users";

                // Update Gauge (System Health)
                // Heuristic: If > 5 flagged tx, risk increases
                let riskLevel = 0;
                if(data.flagged_transactions > 5) riskLevel = 70;
                else if(data.flagged_transactions > 0) riskLevel = 30;
                
                let safeLevel = 100 - riskLevel;
                let color = riskLevel > 50 ? '#dc3545' : (riskLevel > 0 ? '#ffc107' : '#28a745');
                let label = riskLevel > 50 ? 'Critical' : (riskLevel > 0 ? 'Moderate' : 'Secure');

                updateGauge(riskLevel, safeLevel, color, label);

            } catch (error) {
                console.error("Error loading admin stats", error);
            }
        }

        let gaugeChart;
        function updateGauge(risk, safe, color, label) {
            const ctxGauge = document.getElementById('gaugeChart').getContext('2d');
            
            if(gaugeChart) gaugeChart.destroy();

            gaugeChart = new Chart(ctxGauge, {
                type: 'doughnut',
                data: {
                    labels: ['Risk', 'Safe'],
                    datasets: [{
                        data: [risk, safe],
                        backgroundColor: ['#e0e0e0', color], 
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '85%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // Update Text
            const container = document.querySelector('.gauge-panel');
            container.querySelector('h2').innerText = risk;
            container.querySelector('h2').style.color = color;
            container.querySelector('p').innerText = "Level: " + label;
        }

        async function loadFeed() {
            try {
                const response = await fetch('/api/admin/transactions');
                const data = await response.json();
                const container = document.getElementById('feed-container');
                container.innerHTML = '';
                
                if (data.transactions && data.transactions.length > 0) {
                    // Filter for flagged/high risk or show all
                    data.transactions.slice(0, 10).forEach(tx => {
                        let badgeClass = 'bdg-info';
                        let badgeText = 'Monitor';
                        
                        if(tx.CyberRiskScore > 80) { badgeClass = 'bdg-danger'; badgeText = 'Critical'; }
                        else if(tx.CyberRiskScore > 50) { badgeClass = 'bdg-warning'; badgeText = 'Alert'; }
                        else { badgeClass = 'bdg-info'; badgeText = 'Cleared'; }

                        const li = document.createElement('li');
                        li.className = 'feed-item';
                        li.innerHTML = `
                            <div class="feed-info">
                                <span class="feed-id">${tx.AccountID}</span>
                                <span style="color:#666; font-size:0.9rem;">${tx.Description}</span>
                            </div>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        `;
                        container.appendChild(li);
                    });
                } else {
                    container.innerHTML = '<li class="feed-item" style="color:#999; justify-content:center;">System Idle</li>';
                }
            } catch(e) { console.error("Feed error", e); }
        }

        // Init
        loadDashboard();
        loadFeed();
        setInterval(loadDashboard, 5000);
        setInterval(loadFeed, 3000);
        
        // --- 3. Bar Chart (Static for now) ---
        const ctxBar = document.getElementById('barChart').getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                datasets: [{
                    label: 'Threat Alerts',
                    data: [2, 5, 3, 8, 4, 6], // Mock data for visual appeal
                    backgroundColor: '#1a4d8c',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 10, grid: { borderDash: [2, 2] } },
                    x: { grid: { display: false } }
                }
            }
        });
    </script>
</body>
</html>
